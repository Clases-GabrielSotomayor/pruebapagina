---
title: "Análisis de datos estadísticos en R"
author: "Valentina Andrade"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    self_contained: true
    lib_dir: "libs"
    chakra: "libs/remark-latest.min.js"
    css: ["default", "css/ath-slides.css", "css/ath-inferno-fonts.css", "css/animate.css"]
    seal: false
    includes:
      after_body: "html/insert-logo.html"
    anchor_sections: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      beforeInit: "libs/macros.js"
      navigation:
        scroll: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, 
                      fig.retina = 3, fig.align = "center")
```

```{r packages-data, include=FALSE}
pacman::p_load(tidyverse, sjPlot, ggsci, wordcloud2)
theme_set(theme_sjplot2())
```

```{r xaringanExtra, echo=FALSE}
xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "share_again", "scribble", "frezeeframe", "editable"))
```

```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\">Copiar código</i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\">¡Listo!</i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


class: center middle main-title section-title-1 top-logo

.small[
# Análisis de regresión logística
]

.class-info[
<br>
**Sesión N° 4**<br>
**Análisis Avanzado de Datos II**
<br>

.pull-right.small[
**Profesor** Gabriel Sotomayor López <br>
**Ayudante** Anaís Herrera
.tiny[Universidad Diego Portales<br>
]
]

]


---
class: title title-inv-1

# Contenidos Sesión N°4


.box-2.medium.sp-after-half[**Modelos de probabilidad lineal**]

.box-4.medium.sp-after-half[**Modelo de regresión logística binaria**]

.box-1.medium.sp-after-half[**Odds y odds ratios**]

---
class: title title-inv-1

# Contenidos Sesión N°4

.box-1.medium.sp-after-half[**Cálculo de modelos e interpretación de coeficientes**]

.box-2.medium.sp-after-half[**Estadísticos de ajuste y selección de modelos**]

.box-3.medium.sp-after-half[**Visualización de resultados**]


---

class: center middle main-title section-title-2 top-logo

# Modelos de probabilidad lineal

---

class: title title-2

# Regresiones para variables dicotómicas

La semana pasada revisamos los modelos de regresión lineal múltiple, que nos permiten analizar la relación de una variable dependiente continua y variables independientes de cualquier nivel de medida. Ahora cabe la pregunta:


.box-2.medium.sp-after-half[¿cómo podemos modelar variables dicotómicas?]

---
class: title title-2

#Modelos de probabilidad lineal


<style>
.left {
  float: left;
  width: 50%;
  padding: 0 20px;
  box-sizing: border-box;
}

.right {
  float: right;
  width: 50%;
  padding: 0 20px;
  box-sizing: border-box;
}
</style>

<div class="left">
Una opción son los modelos de probabilidad lineal, los cuales consisten en usar una regresión estimada mediante mínimos cuadrados ordinarios para una variable dicotóimica (valores 0 y 1). En estos los valores beta pueden interpretarse como cambios promedio en la probabilidad.
</div>

<div class="right">

<table class="texreg" style="margin: 10px auto;border-collapse: collapse;border-spacing: 0px;caption-side: bottom;color: #000000;border-top: 2px solid #000000;">
<caption>Statistical models</caption>
<thead>
<tr>
<th style="padding-left: 5px;padding-right: 5px;">&nbsp;</th>
<th style="padding-left: 5px;padding-right: 5px;">Pobreza según sexo JH</th>
</tr>
</thead>
<tbody>
<tr style="border-top: 1px solid #000000;">
<td style="padding-left: 5px;padding-right: 5px;">Intercepto</td>
<td style="padding-left: 5px;padding-right: 5px;">0.08<sup>&#42;&#42;&#42;</sup></td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">&nbsp;</td>
<td style="padding-left: 5px;padding-right: 5px;">(0.00)</td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">Mujer (ref.hombre)</td>
<td style="padding-left: 5px;padding-right: 5px;">0.04<sup>&#42;&#42;&#42;</sup></td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">&nbsp;</td>
<td style="padding-left: 5px;padding-right: 5px;">(0.00)</td>
</tr>
<tr style="border-top: 1px solid #000000;">
<td style="padding-left: 5px;padding-right: 5px;">R<sup>2</sup></td>
<td style="padding-left: 5px;padding-right: 5px;">0.00</td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">Adj. R<sup>2</sup></td>
<td style="padding-left: 5px;padding-right: 5px;">0.00</td>
</tr>
<tr style="border-bottom: 2px solid #000000;">
<td style="padding-left: 5px;padding-right: 5px;">Num. obs.</td>
<td style="padding-left: 5px;padding-right: 5px;">62911</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="font-size: 0.8em;" colspan="2"><sup>&#42;&#42;&#42;</sup>p &lt; 0.001; <sup>&#42;&#42;</sup>p &lt; 0.01; <sup>&#42;</sup>p &lt; 0.05</td>
</tr>
</tfoot>
</table>

  </ul>
</div>

---

class: title title-2

# Modelos de probabilidad lineal

A pesar de la simpleza de su interpretación, los modelos de probabildiad lienal cuentan con dos problemas:

.box-2.sma.sp-after-half[1) Pueden entregar variables predichos más allá del rango 0-1 lo cual no tiene sentido en el caso de una probabilidad]

.box-2.sma.sp-after-half[2) No entregan un buen ajuste en términos de cumplimiento de los supuestos del modelo y ajuste a los datos]



---

class: center middle main-title section-title-4 top-logo

# Modelo de regresión logística binaria

---

class: title title-4

# Regresión logistica

Una solución a los problemas anteriormente revisado es utilizar otro tipo de modelo: un modelo de regresión logística binaria. En lugar de modelar la probabilidad directamente, hacemos una transformación la la varaibles dependeinte: modelamos el logaritmo de los odds (chances).

.center[![:scale 50%](https://media.licdn.com/dms/image/C4D12AQECoCrreAiteg/article-inline_image-shrink_1000_1488/0/1546295790796?e=1682553600&v=beta&t=uLtnpgp2IFmmzXmBSXTaRSkBTx2vBeifL_KjUY9d9PY)]

---

class: title title-4

# Regresión logistica

![:scale 100%](https://www.statdeveloper.com/wp-content/uploads/2020/02/regresion-lineal-vs-regresion-logistica.png)

---

class: center middle main-title section-title-1 top-logo

# Odds y odds ratios

---

class: title title-1

# Concepto de Odds

Los odds (chances) corresponden a la razón entre la probabilidad de que algo ocurra dividio por la probabildiad de que algo no ocurra.

$$Odds = {p\over1-p}$$ 
Ejemplo en CASEN 2020, odds de ser pobre

Odds pobreza = 0.095/0.905 = 0.105

Es decir, de acuerdo a la CASEN 2020, las chances de ser pobre son de 0.105
---
class: title title-1

# Concepto de Odds

Odds de **1** significa que existen chances iguales de la correncia o no ocurrencia de cierto hecho.

Odds **menores de 1** dan cuenta de chances negativas (es más probable que ocurra a que no ocurra)

Odds **mayores a 1** dan cuenta de chances positivas (es más probable que ocurra a que no ocurra)


---
class: title title-1

# Odds de dos grupos

En nuestro ejemplo original queremos ver como cambia la probabilidad de que un hogar este en la pobreza según sexo del jefe de hogar.

$$Odds_{JH- Hombre} = 0.076/0.924=0.08225 $$

$$Odds_{JH- Mujer} = 0.114/0.886=0.1286 $$
Es decir, 8,22 hogares con jefatura masculina de cada 100 se encuentra en situación de pobreza, mientras que 1,86 de cada 100 en aquellos con jefatura femenina.

---
class: title title-1

# Concepto de Odds ratio

Los odds ratio resultan útiles para comparar la asociación entre las chances de dos variables dicotómicas.

OR de pobreza de un hogar con jefatura masculina / OR de pobreza de un hogar con jefatura masculina

$$Odds\: ratios = {{p_{m}(1-p_{m})}\over p_{h}(1-p_{h})}$$ 
$$= {0.114/0.886 \over 0.076/0.924} = {0.1286\over 0.08225}= 1.564 $$ 
---
class: title title-1

# Concepto de Odds ratio

Las chances de un hogar con jefatura femenina de encontrarse esn situación de pobreza son 1,564 veces mayores a las chanches de un hogar con jefatura masculina.

.box-1.sma.sp-after-half[Los odd ratios nos permiten resumir en un número la relación entre dos variables categóricas]

Ahora con estos conceptos en mente pasemos a ver como se ajusta un modelo de regresión logística.
---
class: center middle main-title section-title-1 top-logo

# Cálculo de modelos e interpretación de coeficientes
---
class: title title-1

# Cálculo de modelo en R: función GLM

Para estimar un modelo de regresión logística binaria en R debemos usar la función glm, incluida en r base


```{r, eval=FALSE}
glm(pobre~as_factor(sexo), 
    data=base[base$pco1==1,], # filtro por JH
    family="binomial")
```

Especificamos la formula igual que en una regresiónj lineal (la variable dependiente debe estar en formato 0-1). Debemos especificar la familia de modelos (ya que la función glm sirve pára calcular distintos tipos de modelos lienales generalizados). 
---


<style>
.left {
  float: left;
  width: 50%;
  padding: 0 20px;
  box-sizing: border-box;
}

.right {
  float: right;
  width: 50%;
  padding: 0 20px;
  box-sizing: border-box;
}
</style>

<div class="left">
Los beta de un modelo de regresión logística están puestos en términos del logaritmo de los odds.   

Es decir, el beta de mujer nos indica que los log-odds de encontrarse en situación de pobreza aumentan en 0.41 en las mujeres en relación a los hombres. 
</div>

<div class="right">

<table class="texreg" style="margin: 10px auto;border-collapse: collapse;border-spacing: 0px;caption-side: bottom;color: #000000;border-top: 2px solid #000000;">
<caption>Statistical models</caption>
<thead>
<tr>
<th style="padding-left: 5px;padding-right: 5px;">&nbsp;</th>
<th style="padding-left: 5px;padding-right: 5px;">Pobreza según sexo JH</th>
</tr>
</thead>
<tbody>
<tr style="border-top: 1px solid #000000;">
<td style="padding-left: 5px;padding-right: 5px;">Intercepto</td>
<td style="padding-left: 5px;padding-right: 5px;">-2.40<sup>&#42;&#42;&#42;</sup></td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">&nbsp;</td>
<td style="padding-left: 5px;padding-right: 5px;">(0.02)</td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">Mujer (ref.hombre)</td>
<td style="padding-left: 5px;padding-right: 5px;">0.41<sup>&#42;&#42;&#42;</sup></td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">&nbsp;</td>
<td style="padding-left: 5px;padding-right: 5px;">(0.03)</td>
</tr>
<tr style="border-top: 1px solid #000000;">
<td style="padding-left: 5px;padding-right: 5px;">AIC</td>
<td style="padding-left: 5px;padding-right: 5px;">41074.58</td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">BIC</td>
<td style="padding-left: 5px;padding-right: 5px;">41092.68</td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">Log Likelihood</td>
<td style="padding-left: 5px;padding-right: 5px;">-20535.29</td>
</tr>
<tr>
<td style="padding-left: 5px;padding-right: 5px;">Deviance</td>
<td style="padding-left: 5px;padding-right: 5px;">41070.58</td>
</tr>
<tr style="border-bottom: 2px solid #000000;">
<td style="padding-left: 5px;padding-right: 5px;">Num. obs.</td>
<td style="padding-left: 5px;padding-right: 5px;">62911</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="font-size: 0.8em;" colspan="2"><sup>&#42;&#42;&#42;</sup>p &lt; 0.001; <sup>&#42;&#42;</sup>p &lt; 0.01; <sup>&#42;</sup>p &lt; 0.05</td>
</tr>
</tfoot>
</table>

  </ul>
</div>
---
class: title title-1

# Interpretación de coeficientes

Para poder realizar una interpretación con sentido de los coeficientes del modelo debemos realizar una transformación, de forma que el beta quede expresado como odds. Para esto debemos hacer una **exponenciación** de los coeficientes.


```{r, eval=FALSE}
exp(0.41)=1.506818
```

Es decir, los odds (chances) de ser pobre para un hogar con jefatura femenina son 1,506818 veces más que las de uno con jefatura masculina.

---
class: title title-1

# Modelos con múltiples variables independientes

Para poder realizar una interpretación con sentido de los coeficientes del modelo debemos realizar una transformación, de forma que el beta quede expresado como odds. Para esto debemos hacer una **exponenciación** de los coeficientes.


```{r, eval=FALSE}
exp(0.41)=1.506818
```

Es decir, los odds (chances) de ser pobre para un hogar con jefatura femenina son 1,506818 veces más que las de uno con jefatura masculina.


---
class: center middle main-title section-title-2 top-logo

# Estadísticos de ajuste y selección de modelos

---

class: title title-2

# Estadísticos de ajuste

---

class: center middle main-title section-title-3 top-logo

# Visualización de resultados

---

class: title title-3

# Regresión logistica

---
# Orden de un script


.center[
![:scale 80%](https://github.com/learn-R/slides/raw/main/img/02/orden-sintaxis.png)]

---
                                                

# Paso 1: Cargar paquetes

---
class: center middle main-title section-title-2 top-logo

# Cargar paquetes

- Este proceso de compone de dos partes esenciales

(1) Instalar paquetes (`ìnstall.packages()`)

(2) Llamar paquetes (`library()`). Veamos su paso a paso

---
class: title title-2

# Una forma fácil de cargar paquetes: `pacman`

- `pacman` es un paquete que *literalmente* se comió procesos de R `base` y las simplificó en funciones únicas y más intuitivas. 

![:scale 40%](https://github.com/learn-R/slides/raw/main/img/01/pacman.jpg)
---
class: title title-2

# `p_load()`

-  Resume las funciones `library()` e `install.packages()`
  - optimiza esta relación entre ambas pues solo las aplica cuando son necesarias (if `requiere()`), es decir, **¡no te reinicia R si ya está instalada la librería!**
  
---
# Paso 1: Cargar paquetes

```{r}
pacman::p_load(tidyverse, #<<
               magrittr,
               car,
               sjmisc)
```



---
layout: false
name: renv
class: center middle section-title section-title-3 animated fadeIn

# Paso 2: Importar datos

---
class: title title-3

# Importar datos

.box-inv-3.center[Una vez que hemos decidido qué datos queremos trabajar]

--

.box-inv-3[Un paso evidente es cargar los datos]

--

.box-inv-3[¡Y en R no es la excepción! De hecho, hablamos que R facilita el **almacenaje de datos**]

---
class: title title-3
# Consideraciones antes de importar datos 

Para **importar** los datos en R debemos tener en consideración tres cosas:

1. Cómo se llaman los datos (en nuestro caso Casen en Pandemia 2020 STATA)

2. El formato de nuestros datos (en nuestro caso .sav)

3. El lugar de donde están alojados nuestros datos. 


---
class: center middle main-title section-title-3 top-logo

# ¡Vamos a este segundo paso en el script: Cargar datos!

---

# ¿Dónde?

.box-inv-1[[Descargar el zip de la clase N°3 el sitio del curso](https://learn-r-uah.netlify.app/content/03-content/)]

---
class: title title-4

# 1. Recursos de la clase N°3 y práctica N°3

- Datos: *Encuesta de Caracterización Socioeconómica (CASEN)* (2020).

- Para ello, deben dirigirse al [siguiente enlace](https://drive.google.com/drive/folders/1Orgb3Qb9LcjTfjYMdIdy7SWd3xDMrTbG?usp=sharing) y descargar los zip.


- [**Libro de códigos**](http://observatorio.ministeriodesarrollosocial.gob.cl/storage/docs/casen/2020/Libro_de_codigos_Base_de_Datos_Casen_en_Pandemia_2020.pdf) antes de trabajar una base de datos.

---
class: title title-4

# Paquetes

1. `pacman`: este facilita y agiliza la lectura de los paquetes a utilizar en R

2. `sjmisc`: explorar datos

3. `tidyverse`: colección de paquetes, del cuál utilizaremos `dplyr` y `haven`

4. `haven`: cargar y exportar bases de datos en formatos .sav y .dta

5. `readxl` y `writexl`: para cargar y exportar bases de datos en formato .xlsx y .xls

6. `dplyr`: nos permite seleccionar variables de un set de datos

---
class: center middle main-title section-title-3 top-logo

# ¡No fue tan difícil!

--

# Repasemos algunos **elementos**

---

# Consideraciones antes de importar datos 

Para **importar** los datos en R debemos tener en consideración tres cosas:

.can-edit.key-likes[
1.
2.
3.
]

---

# Tipos de variables

| Clase  | Tipo de variable |
|---------:|:--------|
| `numeric` | Cuantitativa |
| `character` | Categórica |
| `Logic` |  Lógica (TRUE, FALSE, NA) |
| `factor` | Categórica con niveles y etiquetas |

--

A repasar con dos materiales complementarios: [Tipos de variables](resources/r-datatypes)  y [Tipos de variables](resources/r-datatypes-example)

---
layout: false
class: center section-title section-title-5 animated fadeIn

# En síntesis


.box-2.medium.sp-after-half[**Importar y exportar datos**]

--

.box-3.medium.sp-after-half[**Validación y limpieza datos**]

--

.box-4.medium.sp-after-half[**Selección de variables**]


---
class: center middle main-title section-title-4 top-logo

# ¡Y a no olvidar el flujo para el análisis!

--

## Nos permite hacernos amigas/os más rápido del programa
---

.center[
![:scale 80%](https://github.com/learn-R/slides/raw/main/img/01/flow-rproject.png)]

---
layout: false

.box-1[¿Y eso era?]

--

.box-inv-1[¡Antes! **Dos bonus track**]


---
class: title title-8

# Dos bonus track

- ¿Cómo hacer mi propio repositorio en GitHub?

--

- ¡Vamos a verlo!

---
class: title title-8

# Dos bonus track: cargar datos en url

- ¿Cómo cargar datos desde una **url**?
  - Seguir los tres pasos para importar datos
  - Hint: `funcion(url("ruta_web"))`
  
--

- Quienes averiguen **como** cargar datos con url tendrán +0.5 décimas para la tarea N°2.
  - Deben dejar en slack un ejemplo reproducible en el canal `#tareas`
  - Pueden hacerlo **hasta antes del lunes 30**

---

.box-inv-1[¡Ahora si que si! Nos vemos el próximo **lunes** en la clase N°4]

.box-inv-1.small[**No olvides hacer el práctico antes**]

.center[
![](https://github.com/learn-R/slides/raw/main/img/01/monster-inc-2.gif)]
---
layout: false
class: center middle main-title section-title-1 top-logo

.small[
# Importar, validar y explorar datos
]

.class-info[
<br>
**Sesión N° 4**<br>
**Análisis de regresión logística**
<br>

.pull-right.small[
**Profesor** Gabriel Sotomayor López <br>
**Ayudante** Anaís Herrera
.tiny[Universidad Diego Portales<br>
]
]

]

